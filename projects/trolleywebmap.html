<!DOCTYPE html>

<html lang="en">
  
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>projects | Trolley Webmap | baysidets</title>
		<link rel="stylesheet" href="../styles/main.css">
	</head>

	<body>
		<div id="header">
			<a href="../index.html">
				<img src="../assets/logos/logo.svg">
			</a>
		</div>
		<div id="main">
			<div id="nav-links">
				<a class="nav-link" href="../index.html" id="home">
					home
				</a>
				<a class="nav-link" href="../projects.html" id="projects" style="background-color: hsl(30, 90%, 70%); color: black;">
					projects
				</a>
				<a class="nav-link" href="../blog.html" id="blog">
					blog
				</a>
				<a class="nav-link" href="../wiki.html"  id="wiki">
					wiki
				</a>
			</div>
			<div id="content">
				<h1>TROLLEY WEBMAP</h1>
				<h2>Scope</h2>
				<p>The end product of this project is a map made available on the internet that shows the real-time live location of the Perth Amboy Hometown Heritage Trolley.</p>
				<h2>Log</h2>
				<h3>2024-10-30</h3>
				<ul>
					<li><b>Tracking Device:</b> Unfortunately, the Freematics ONE+ did not work out in the field. They tested the device plugged into the OBD port of the trolley and while it turned on, it did not report any data to the server. It seems that the device was not connecting to the trolley's on-board WiFi whatsoever. Even after guiding them through re-uploading the sketch with the verified WiFi information using PlatformIO IDE, it wouldn't budge. Therefore, for now and probably permanently, the Freematics device is a no-go.
					<p>Alternatively, we will be using a cellphone, probably an old iPhone they have laying around, and the Traccar Client app. This setup is way more straightforward and hassle-free, and despite the potential benefits the Freematics device presented (namely power via OBD and other vehicle-related data reporting), I admit this is the route we should have gone with from the get-go...</p>
					<p>Setting up a phone to use Traccar Client is rather simple. All it takes is downloading the Traccar Client app, adding the device identifier provided in the app to the Traccar instance running on the Data Server, providing the correct server URL in the Client app, and toggling the service. We've tested this several times on multiple devices and there have been no issues. This is the really, really easy part though. Everything else, for me at least, is much harder to deal with.</p></li>
					<li><b>Data Server:</b> The Traccar instance running on the instance is just fine still. I am learning how to properly send HTTP requests to it to get the data needed for the webmap, though I am finding it difficult to understand the documentation for the API. It doesn't help that the maintainer of the software loves giving dry, unhelpful responses to questions that point to exactly what I am having issues with.</li>
					<li><b>Web Server:</b> I haven't yet set up DNS for the web server yet as I haven't been told a domain name. However, once the time comes, I'll also have to setup SSL/TLS as this will be a very public-facing website. This will be a good opportunity to learn about web security and SSL/TLS, the lessons from which I hope to apply to this website and any others I will create in the future.</li>
					<li><b>Webmap:</b> This is where the magic is <i>supposed</i> to happen. I am not very concerned with the Leaflet stuff (styling, the route, etc.) What I am concerned about is setting up the Fetch constructs correctly to make the HTTP requests to get the position data of the trolley tracker from Traccar. One particular issue I am having right now is authenticating my requests. I'll write on this more extensively later, but I am getting a <span class="file-path">401: Unauthorized error</span> when I make my request. The headers I include in my request contain a base 64-encoded username/password combo, the username and password being those credentials I use to log into the Traccar manager running on the server. For one, I don't even know if that's the username/password combo that I am supposed to be providing, further yet if I am even <i>supposed</i> to be providing a username/password in the header. If I am, though, I don't know if "basic" is the right authentication method. This will all take more learning, Googling, and ChatGPTing that I have very little time to do.</li>
				</ul>
				<p><b>Let me try to summarize what I have left to do:</b></p>
				<ul>
					<li>
						Successfully retrieve position data for the test device from Traccar using Fetch API or WebSocket API.
						<ul>
							<li>This may be easier due to the request going to and coming from the same machine, just different ports.</li>
						</ul>
					</li>
					<li>
						Establish a stable connection between webmap (web server) and Traccar (data server).
					</li>
					<li>
						Reconfigure connection to acquire data from correct tracking device.
					</li>
					<li>
						Properly organize webmap code (integrating scripts with <span class="file-path">index.html</span>).
					</li>
					<li>
						Stylize Leaflet and webpage.
					</li>
				</ul>
				<h3>2024-10-21</h3>
				<p>I've managed to get some, but not a whole lot, more progress over the last days:</p>
				<ul>
					<li><b>Tracking Device:</b> I ran tests in the outdoors and the GNSS sensor does indeed collect the correct latitude/longitude. I observed this through the serial monitor in the PlatformIO IDE through VSCode. However, when I ran the test outdoors, I set up the <span class="file-path">config.h</span> file to connect to my mobile hotspot, and for whatever reason, it refused to connect to it. I made sure my hotspot was discoverable while the device was attempting to connect to it, and I even tested that the tracking device could connect to the hotspot back in my apartment with success, I think. But, I can no longer replicate this success.
					<p>So, back in my apartment, I have resorted to using my home WiFi for the Freematics sketch. <b>I must remember to fill <span class="file-path">config.h</span> with the trolley WiFi information before sending the device back.</b> It is still, as expected, sending 0, 0 to the Traccar server, but it is at least sending information over, confirming the WiFi connection is stable.</p>
					<p>My thought right now is to send the device back tomorrow <i>hoping</i> that it works out just fine, and in the meantime, I'll use my phone with the Traccar Client application installed for testing purposes. I registered my phone with the Traccar Manager in the server and confirmed that it connects fine and relays location correctly. So I'll use data from my phone in the Traccar server database as a placeholder, and then eventually change any corresponding endpoint/database info in the codebase to fit the Freematics device when that time comes.</p>
					<p>If I can't get the Freematics device to work over there, I will advise that they return it and instead use an Android phone with the Traccar Client app. This probably would've been the much simpler and straight-forward option from the beginning, but as they say, hindsight is 20-20. But to be frank, the tracking device is the least of my concerns right now...</p></li>
					<li><b>Data Server:</b> The Traccar server is functioning normally as far as I know. I've familiarized myself with it and the MySQL database a bit more, and I should continue to do so as doing so will be key to knowing how to feed the location data to the webmap.</li>
					<li><b>Web Server:</b> The web server is also functioning fine. I don't have any DNS set up for it yet, but I have to ask what domain name we want to go with so I can set that up. I will probably register the domain with CloudFlare as that's what I am used to. I am not sure if DigitalOcean requires any additional DNS configuration with their droplets, but I will have to look into that too.</li>
					<li><b>Webmap:</b> This is perhaps where I am at my weakest. I've laid out a skeleton with a navigation bar and a Leaflet map instance, and I've even loaded the route as a GeoJSON, but I am very, very ripe with the Javascript required to fully develop this.
						<ul>
							<li>For one, I would like the script that loads the Leaflet map to be a separate file that I then reference into the <span class="file-path">index.html</span> instead of an "inline script". This is because said script is bound to get pretty chunky, as it already has with the route GeoJSON which consists of several hundred points.
							<p>It is a smart idea to look at how other people have constructed Leaflet projects.</p></li>
							<li>I also need a Javascript refresher, and I need to learn asynchronous Javascript and how to write Javascript to interact with a web server and its files.</li>
							<li>Probably related to the latter item, I need to figure out what entity I should be reading from for realtime location data from Traccar. This is where the Traccar API comes in, but they already threw me off with the mention of the endpoint being <span class="file-path">/api/socket</span> (this is the endpoint for their WebSocket API, which differs from their REST API endpoint; I assume I'll need to use the WebSocket API for realtime data as indicated on their API page: <a href="https://www.traccar.org/traccar-api/">https://www.traccar.org/traccar-api/</a>.) It is also entirely possible that I don't have to use the API at all and I can instead get away with interacting with the database or perhaps some .csv or other file in the server. But, I suppose APIs are supposed to make interacting with applications easier, so it's probably best that I try to use the API first.</li>
						</ul>
					</li>
				</ul>
				<h3>2024-10-17, 2024-10-16, 2024-10-15, 2024-10-13</h3>
				<p>By this point, I've had this project on my plate for more than a few months, progressively chipping away at the research part of it but never really bringing it to a point where I can confidently say I know what I have to do.</p>
				<p>Let me break down the components of this project in order to describe the research I've done to this point and what is left (which is everything, basically):</p>
				<ul>
					<li>
						<b>Tracking Device:</b> I am using a Freematics ONE+ Model A with an external GNSS receiver. The device will connect to the trolley via OBD-II, though I am currently connecting to my computer via USB. Eventually (soon), I'll have to test on a vehicle.
						<ul>
							<li><b>Status:</b> The device is semi-operational. It turns on O.K. connecting to my laptop via USB. To get the device working as it should, I had to load and compile the telelogger sketch made available by Freematics (read the Developer Guide here: <a href="https://freematics.com/pages/products/freematics-one-plus/">https://freematics.com/pages/products/freematics-one-plus/</a> and the sketch source code here: <a href="https://github.com/stanleyhuangyc/Freematics/tree/master/firmware_v5/">https://github.com/stanleyhuangyc/Freematics/tree/master/firmware_v5/</a>). We had tried going the Freematics Arduino Builder route before with no success, so I went the PlatformIO route instead. I installed VS Code and the PlatformIO extension, which provided the Serial Monitor, which itself was key to checking on the state of the device as it communicated with the server.
							<p>So I uploaded the sketch successfully after modifying <span class="file-path">config.h</span> to include the correct WiFi and server information. Checking the Traccar Manager confirmed that I installed the Traccar server correctly onto the virtual private server, registered the device correctly there, and configured the Freematics sketch properly. However, the device reported a 0, 0 latitude/longitude (what I learned is called the "null island").</p>
							<p>This is where we're at now. I haven't managed to find a fix for it, but I wonder if this is because I've done all testing from the comfort of my apartment. Perhaps by testing by connecting to a vehicle via OBD-II, in motion and outdoors, I may get a different result. Another potentially confounding factor is the storage situation. I believe I asked the powers that be to purchase the device including the microSD card (which I believe should already come installed with the option of including it selected), but I have to verify by opening the little port on the side of the device. After verifying, I must go into <span class="file-path">config.h</span> and make sure it forces storage to the microSD.</p>
							<p>While time passes as I get the opportunity to test with a vehicle, it's best that I go ahead and work on setting up the domain, web server, front-end, and back-end. I have a location data stream at least (though it's 0, 0), so it's something that I can get started with.</p></li>
						</ul>
					</li>
					<li>
						<b>Data Server:</b> The data from the Freematics device will transmit the data via WiFi to a Freematics server running on a DigitalOcean droplet listening on port 5170. The virtual private server (VPS) is crucial here in order to have a static IP address. I could go the DuckDNS route but that would just add more points of potential failure. The Freematics server is nice because it integrates a MySQL database as well as the Traccar Manager application which will help with debugging. The idea will be to grab from the database when building the webmap. Traccar has an API which may also be handy.
					</li>
					<li>
						<b>Web Server:</b> The website will run on an Apache2 web server.
						<ul>
							<li><b>Status:</b> I set up the web server on the DigitalOcean droplet by doing the following:</li>
							<ul>
								<li>SSH'd into the server: <span class="file-path">ssh root@[ipv4 address]</span></li>
								<li>Installed Apache2: <span class="file-path">apt install apache2</span></li>
								<li>Configured the Apache2 web server:</li>
								<ul>
									<li>
										Appended the following to <span class="file-path">/etc/apache2/apache2.conf</span>:
										<br><span class="file-path">ServerName 127.0.0.1</span>
									</li>
								</ul>
								<li>Apache2 defaults to using port 80 for the HTTP protocol and port 443 for HTTPS. I opened both ports in the firewall: <span class="file-path">ufw allow 80 443</span></li>
								<li>Tested the web server by going to <span class="file-path">[ipv4 address]:80</span></li>
							</ul>
						</ul>
					</li>
					<li>
						<b>The Actual Map:</b> A Leaflet.js front-end.
						<ul>
							<li><b>Status:</b> I am slowly starting to develop this as I go through the Leaflet.js documentation. I've managed to initialize a map instance, set up some markers, and add the route as a GeoJSON. Right now, the GeoJSON is real ugly so I'll need to prettify it without having Vim go crazy on me since I have braces mapped to automatically close themselves. At some point too, it would be ideal to have the GeoJSON as a separate file imported into the script, but I don't yet understand asynchronous Javascript very well and how I'd direct Leaflet to look for the GeoJSON on the web-server-to-be.</li>
						</ul>
					</li>
					<!-- Obviously there's a whole layer here missing which is how the web server will communicate with Traccar; will need to expand on this and detail any missing info, such as any issues I bumped into along the way, how I did everything, and any outstanding problems still being faced.-->
				</ul>
			</div>
		</div>
		<div id="footer">
			
		</div>
	</body>
</html> 
